#镜像中要安装cloud-init组件
```
yum install cloud-init,python-jsonpatch,dracut-modules-growroot,cloud-utils-growpart
dracut --force 
```
#修改镜像中配置文件。nocloud模版不需要这个配置文件/etc/cloud/cloud.cfg.d/99_cloudstack.cfg，要删除。
```
## sysprep stuff 
# remove existing SSH keys - if generated - as they need to be unique 
rm -rf /etc/ssh/*key* 
# the MAC address will change 
sed -i '/HWADDR/d' /etc/sysconfig/network-scripts/ifcfg-eth0 
sed -i '/UUID/d' /etc/sysconfig/network-scripts/ifcfg-eth0 
# remove logs and temp files 
yum -y clean all 
rm -f /root/anaconda-ks.cfg 
rm -f /root/install.log 
rm -f /root/install.log.syslog 
find /var/log -type f -delete 
# remove the random seed, it needs to be unique and it will be autogenerated 
rm -f /var/lib/random-seed 
# Kdump can use quite a bit of memory, do we want to keep it? 
sed -i s/crashkernel=auto/crashkernel=0@0/g /boot/grub/grub.conf 

# tell the system to autorelabel? this takes some time and memory, maybe not advised 
# touch /.autorelabel 

## set cloudstack as data source in cloud-init with the modifications from exoscale.ch - thanks 
cat << EOF > /etc/cloud/cloud.cfg.d/99_cloudstack.cfg 
datasource: 
  CloudStack: {} 
  None: {} 
datasource_list: 
  - CloudStack 
EOF 
#fix userdata url issue with ending slash 
sed -i '385i \ \ \ \ #cloudstack fix remove ending slash' /usr/lib/python2.6/site-packages/boto/utils.py 
sed -i '386i \ \ \ \ ud_url = ud_url[:-1]' /usr/lib/python2.6/site-packages/boto/utils.py 
sed -i 's,disable_root: 1,disable_root: 0,' /etc/cloud/cloud.cfg 
sed -i 's,ssh_pwauth:   0,ssh_pwauth:   1,' /etc/cloud/cloud.cfg 
sed -i 's,name: cloud-user,name: root,' /etc/cloud/cloud.cfg 

mkdir -p /var/lib/cloud/scripts/per-boot 
cat > /var/lib/cloud/scripts/per-boot/10_cloud-set-guest-password << "EOF" 
#!/bin/bash 
# 
# Init file for Password Download Client 
# 
# chkconfig: 345 98 02 
# description: Password Download Client 

# Licensed to the Apache Software Foundation (ASF) under one 
# or more contributor license agreements.  See the NOTICE file 
# distributed with this work for additional information 
# regarding copyright ownership.  The ASF licenses this file 
# to you under the Apache License, Version 2.0 (the 
# "License"); you may not use this file except in compliance 
# with the License.  You may obtain a copy of the License at 
# 
#   http://www.apache.org/licenses/LICENSE-2.0 
# 
# Unless required by applicable law or agreed to in writing, 
# software distributed under the License is distributed on an 
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY 
# KIND, either express or implied.  See the License for the 
# specific language governing permissions and limitations 
# under the License. 


# Modify this line to specify the user (default is root) 
user=root 

# Add your DHCP lease folders here 
DHCP_FOLDERS="/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*" 
password_received=0 
file_count=0 
error_count=0 

for DHCP_FILE in $DHCP_FOLDERS 
do 
	if [ -f $DHCP_FILE ] 
	then 
		file_count=$((file_count+1)) 
		PASSWORD_SERVER_IP=$(grep dhcp-server-identifier $DHCP_FILE | tail -1 | awk '{print $NF}' | tr -d '\;') 

		if [ -n "$PASSWORD_SERVER_IP" ] 
		then 
			logger -t "cloud" "Found password server IP $PASSWORD_SERVER_IP in $DHCP_FILE" 
			logger -t "cloud" "Sending request to password server at $PASSWORD_SERVER_IP" 
			password=$(wget -q -t 3 -T 20 -O - --header "DomU_Request: send_my_password" $PASSWORD_SERVER_IP:8080) 
			password=$(echo $password | tr -d '\r') 

			if [ $? -eq 0 ] 
			then 
				logger -t "cloud" "Got response from server at $PASSWORD_SERVER_IP" 

				case $password in 
				 
				"")					logger -t "cloud" "Password server at $PASSWORD_SERVER_IP did not have any password for the VM" 
									continue 
									;; 
				 
				"bad_request")		logger -t "cloud" "VM sent an invalid request to password server at $PASSWORD_SERVER_IP" 
									error_count=$((error_count+1)) 
									continue 
									;; 
									 
				"saved_password") 	logger -t "cloud" "VM has already saved a password from the password server at $PASSWORD_SERVER_IP" 
									continue 
									;; 
									 
				*)					logger -t "cloud" "VM got a valid password from server at $PASSWORD_SERVER_IP" 
									password_received=1 
									break 
									;; 
									 
				esac 
			else 
				logger -t "cloud" "Failed to send request to password server at $PASSWORD_SERVER_IP" 
				error_count=$((error_count+1)) 
			fi 
		else 
			logger -t "cloud" "Could not find password server IP in $DHCP_FILE" 
			error_count=$((error_count+1)) 
		fi 
	fi 
done 

if [ "$password_received" == "0" ] 
then 
	if [ "$error_count" == "$file_count" ] 
	then 
		logger -t "cloud" "Failed to get password from any server" 
		exit 1 
	else 
		logger -t "cloud" "Did not need to change password." 
		exit 0 
	fi 
fi 

logger -t "cloud" "Changing password ..." 
echo $user:$password | chpasswd 
						 
if [ $? -gt 0 ] 
then 
	usermod -p `mkpasswd -m SHA-512 $password` $user 
		 
	if [ $? -gt 0 ] 
	then 
		logger -t "cloud" "Failed to change password for user $user" 
		exit 1 
	else 
		logger -t "cloud" "Successfully changed password for user $user" 
	fi 
fi 
						 
logger -t "cloud" "Sending acknowledgment to password server at $PASSWORD_SERVER_IP" 
wget -t 3 -T 20 -O - --header "DomU_Request: saved_password" $PASSWORD_SERVER_IP:8080 
exit 0 
EOF 

chmod +x /var/lib/cloud/scripts/per-boot/10_cloud-set-guest-password 

cat << EOF > /sbin/ifup-local 
#!/bin/bash 
case "$1" in 
eth0) 
/sbin/ethtool -K $1 tso off gso off 
;; 
esac 
exit 0 
EOF 

chmod +x /sbin/ifup-local 
chcon --reference /sbin/ifup /sbin/ifup-local 

# Enable the serial console login 
echo ttyS0 >> /etc/securetty 
sed -i 's@ACTIVE_CONSOLES=/dev/tty\[1-6\]@ACTIVE_CONSOLES="/dev/tty\[1-6\] /dev/ttyS0"@g' /etc/sysconfig/init 

#bz912801 
# prevent udev rules from remapping nics 
echo "bogus content to prevent udev rules from remapping nics bz912801" > /etc/udev/rules.d/*-persistent-net-generator.rules 

#bz 1011013 
# set eth0 to recover from dhcp errors 
echo PERSISTENT_DHCLIENT="1" >> /etc/sysconfig/network-scripts/ifcfg-eth0 

# set virtual-guest as default profile for tuned 
echo "virtual-guest" > /etc/tune-profiles/active-profile 

# randomise root password 
# openssl rand -base64 32 | passwd --stdin root
```
#编写my-user-data。
ssh_authorized_keys是~/.ssh/id_rsa.pub文件里的内容。
```
#cloud-config 
user: root 
password: engine3344 
chpasswd: { expire: False } 
ssh_pwauth: True 

ssh_authorized_keys: 
 - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDCSD2h73bXl5YBfocjAxGDmwoCi6J2vqRXr8CejaEEMRFtHjg/SNSVMt7rFiHWHuBytPsjbVMLyvm+wz+ZlKDngWXZob2oGgnQPdYFM6evaJjhSoK8anqesI5FCnYdIoyPTXLkO5SR8j8dVbLW81nDlKFu9EvcsUxAGIvnRW7j3Pg6AVMBo7xsk2Mqnl3YUPQ/dTOVUEvUgVuTrDj4jDg6Tj1C15NpcKNOFRxxHMP3Q0dnW3/UIeVD6jH9WGeMwZlLk6BjZ9F2+3KrqXLU1kxpqSPu+V/WRihfzadl1F5/T/l1boC1ICZlBlobNYuQ9PI1gcRWAa1/jXu3K3u9ykop clouder@pc134 

timezone: Asia/Chongqing 

write_files: 
  - path: /etc/sysconfig/network-scripts/ifcfg-eth0 
    content: | 
      DEVICE=eth0 
      ONBOOT=yes 
      BOOTPROTO=static 
      IPADDR=192.168.173.10 
      NETMASK=255.255.255.0 
      GATEWAY=192.168.173.10 

runcmd: 
  - [ifdown, eth0] 
  - [ifup, eth0] 

growpart: 
  mode: auto 
  devices: ['/'] 
  ignore_growroot_disabled: false 
```
#主机中安装cloud-utils，用my-meta-data和my-user-data生成配置镜像my-seed.img和模版镜像my-vm.img一起启动，cloud-init就会自动按照配置文件来修改模版镜像。
```
yum install cloud-utils
echo "instance-id: $(uuidgen || echo i-abcdefg)" > my-meta-data
cloud-localds my-seed.img my-user-data my-meta-data
qemu-system-x86_64 -net nic -net user,hostfwd=tcp::2222-:22 -hda my_vm.img -hdb my-seed.img -m 512 --enable-kvm
```
#cloudmonkey配置
```
(local) mycloudmonkey> set history_file /usr/share/cloudmonkey_history
(local) mycloudmonkey> set log_file /var/log/cloudmonkey                   
(local) mycloudmonkey> set url http://localhost:8080/client/api     
(local) mycloudmonkey> set apikey PNNaF49-PXkrd_8vQJdTkBkLO9zLHLe3VPIF2jsffPwoZnG26n9HNQa4fp03sgLxmc3FSgMJPI4L0DA0OIk3ag                      
(local) mycloudmonkey> set secretkey rmf2PZMr_xeqBUuHeRfy2EDulTkc7eGjY372qvwUssIl3CvlaNb2Jsu4n-EHE8qHD768Ya5JUpgcwDkUgQzwUg
(local) mycloudmonkey> sync
```
#将cloudmonkeyregistertemplate.sh、cloudmonkeydeploy.sh、my-user-data放在同一目录下，如/root
在cloudstack注册模版。修改cloudmonkeyregistertemplate.sh脚本里的name、displaytext、ostypeid、url
```
 chmod +x  cloudmonkeydeploy.sh  cloudmonkeyregistertemplate.sh
 sh cloudmonkeyregistertemplate.sh
```
cloudmonkeyregistertemplate.sh
```
name="manager-base8" 
displaytext="manager-base8" 
featured="False" 
passwordenabled="False" 
public="True" 
ostypeid="cdde0ce4-56ca-11e5-b257-525400cd7603" 
format="QCOW2" 
hypervisor="KVM" 
url="http://192.168.122.1/template/manager-base7.qcow2" 
zonename="Zone1" 
zoneid=`cloudmonkey list zones filter=id,name name="$zonename"|grep "$zonename"|awk '{print $4}'` 
cloudmonkey set display default 
cloudmonkey register template name="${name}" displaytext="${displaytext}" isfeatured=${featured} passwordenabled=${passwordenabled} ispublic=${public} ostypeid=${ostypeid} format=${format} hypervisor=${hypervisor} zoneid=${zoneid} url=${url} 
```
#创建实例，修改cloudmonkeydeploy.sh 脚本中的vmname、templatename、serviceofferingname、zonename、networkname
```
sh cloudmonkeydeploy.sh
```
cloudmonkeydeploy.sh
```
vmname="testuserdata14" 
templatename="manager-base7" 
serviceofferingname="Small Instance" 
zonename="Zone1" 
networkname="iso-vn-001" 

userdata=`cat my-user-data|base64` 

cloudmonkey set display table 
templateid=`cloudmonkey list templates templatefilter=executable filter=name,id name="$templatename"|grep "$templatename"|awk '{print $2}'` 
serviceofferingid=`cloudmonkey list serviceofferings filter=name,id name="$serviceofferingname"|grep "$serviceofferingname"|awk '{print $5}'` 
zoneid=`cloudmonkey list zones filter=id,name name="$zonename"|grep "$zonename"|awk '{print $4}'` 
networkid=`cloudmonkey list networks filter=name,id name="$networkname"|grep "$networkname"|awk '{print $2}'` 

echo templatename=$templatename templateid=$templateid 
echo serviceofferingname=$serviceofferingname serviceofferingid=$serviceofferingid 
echo zonename=$zonename zoneid=$zoneid 
echo networkname=$networkname networkid=$networkid 
echo userdata=$userdata 

cloudmonkey deploy virtualmachine startvm=false serviceofferingid=$serviceofferingid templateid=$templateid zoneid=$zoneid networkids=$networkid name=$vmname userdata="`cat my-user-data|base64`" 
```
my-user-data
```
#cloud-config 
user: root 
password: engine3344 
chpasswd: { expire: False } 
ssh_pwauth: True 

ssh_authorized_keys: 
 - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDCSD2h73bXl5YBfocjAxGDmwoCi6J2vqRXr8CejaEEMRFtHjg/SNSVMt7rFiHWHuBytPsjbVMLyvm+wz+ZlKDngWXZob2oGgnQPdYFM6evaJjhSoK8anqesI5FCnYdIoyPTXLkO5SR8j8dVbLW81nDlKFu9EvcsUxAGIvnRW7j3Pg6AVMBo7xsk2Mqnl3YUPQ/dTOVUEvUgVuTrDj4jDg6Tj1C15NpcKNOFRxxHMP3Q0dnW3/UIeVD6jH9WGeMwZlLk6BjZ9F2+3KrqXLU1kxpqSPu+V/WRihfzadl1F5/T/l1boC1ICZlBlobNYuQ9PI1gcRWAa1/jXu3K3u9ykop clouder@pc134 


timezone: Asia/Chongqing 

write_files: 
  - path: /etc/sysconfig/network-scripts/ifcfg-eth0 
    content: | 
      DEVICE=eth0 
      ONBOOT=yes 
      BOOTPROTO=static 
      IPADDR=192.168.173.10 
      NETMASK=255.255.255.0 
      GATEWAY=192.168.173.10 

runcmd: 
  - [ifdown, eth0] 
  - [ifup, eth0] 

growpart: 
  mode: auto 
  devices: ['/'] 
  ignore_growroot_disabled: false
```
